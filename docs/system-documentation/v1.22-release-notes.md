# Version 1.22 Release Notes

## ğŸ‰ JWT Enhancement & Device Tracking Release

**Release Date:** 2024  
**Version:** 1.22  
**Status:** Ready for Testing

---

## ğŸ“‹ Summary

This release implements comprehensive JWT token enhancements and device tracking capabilities, completing Task #011 (tier checking and device limit enforcement) and aligning with the JWT token plan.

---

## âœ¨ What's New

### 1. Enhanced JWT Tokens
Your license tokens now include:
- **Complete metadata**: Issuer, audience, unique token ID
- **Tier information**: Tier number, name, and status
- **Feature list**: Array of enabled features based on tier
- **Device limits**: Current and maximum device counts
- **Dual tokens**: 24-hour access token + 30-day refresh token

### 2. Device Tracking
- Automatic device registration on activation
- Device limit enforcement (2/5/10 for standard/premium/professional)
- Device status tracking (active/inactive/revoked)
- Device metadata storage (name, hardware info, timestamps)

### 3. Tier Checking API
New endpoint to check customer limits before activation:
```bash
GET /api/licensing/check-limits?email=user@example.com
```

Returns:
- Customer tier and tier name
- Current device count
- Maximum devices allowed
- Available device slots
- Feature list
- List of registered devices
- Helpful messages with upgrade suggestions

---

## ğŸ”§ Technical Details

### New Database Table
```sql
devices (
  id, customer_id, device_id, hw_hash,
  device_name, device_info, first_seen, last_seen, status
)
```

### Enhanced JWT Payload
```json
{
  "iss": "custmgr.aiprivatesearch.com",
  "sub": 1,
  "aud": "aiprivatesearch",
  "jti": "unique-id",
  "email": "user@example.com",
  "tier": 2,
  "tier_name": "premium",
  "features": ["search", "multi-mode", "collections", "models"],
  "max_devices": 5,
  "current_devices": 2,
  "device_id": "device-uuid",
  "token_version": 2,
  "token_type": "access"
}
```

### Modified API Response
```json
{
  "token": "access-token-here",
  "refresh_token": "refresh-token-here",
  "expires_in": 86400,
  "existing": false,
  "message": "License activated successfully"
}
```

---

## ğŸ¯ Use Cases

### Check Before Activation
```bash
# Check if customer can activate more devices
curl "http://localhost:56304/api/licensing/check-limits?email=user@example.com"

# Response shows:
# - Tier: premium
# - Max devices: 5
# - Current devices: 3
# - Available slots: 2
# - Message: "2 device slot(s) available."
```

### Activate Device
```bash
curl -X POST http://localhost:56304/api/licensing/activate \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "hwId": "unique-hardware-id",
    "appVersion": "19.61"
  }'
```

### Handle Device Limit
When limit is reached:
```json
{
  "error": "Device limit reached. Maximum 5 devices allowed for premium tier. Current: 5/5"
}
```

---

## ğŸ“Š Tier Configuration

| Tier | Name | Devices | Features |
|------|------|---------|----------|
| 1 | Standard | 2 | search, collections |
| 2 | Premium | 5 | + multi-mode, models |
| 3 | Professional | 10 | + config, doc-index |

---

## ğŸš€ Deployment Steps

### 1. Local Testing (macOS)
```bash
cd /Users/Shared/AIPrivateSearch/repo/aiprivatesearchcustmgr
./start.sh

# Test new endpoint
curl "http://localhost:56304/api/licensing/check-limits?email=customer@example.com"
```

### 2. Commit Changes
```bash
git add .
git commit -m "v1.22: JWT enhancements, device tracking, and tier checking"
git push origin main
```

### 3. Deploy to Ubuntu
```bash
ssh user@your-server
cd /webs/AIPrivateSearch/repo/aiprivatesearchcustmgr
git pull
pm2 restart ecosystem.config.cjs
pm2 logs
```

### 4. Verify Production
```bash
# Check health
curl https://custmgr.aiprivatesearch.com/api/health

# Test new endpoint
curl "https://custmgr.aiprivatesearch.com/api/licensing/check-limits?email=customer@example.com"
```

---

## ğŸ§ª Testing Checklist

- [ ] Server starts without errors
- [ ] Devices table created in database
- [ ] Check-limits endpoint returns correct data
- [ ] First device activation succeeds
- [ ] Second device activation succeeds (standard tier)
- [ ] Third device activation fails with proper error (standard tier)
- [ ] JWT token includes all new fields
- [ ] Refresh token is returned
- [ ] Token validation works
- [ ] Device count is accurate
- [ ] Upgrade tier allows more devices

---

## âš ï¸ Breaking Changes

### Token Expiration
- **Old:** 30-day access tokens
- **New:** 24-hour access tokens + 30-day refresh tokens

**Impact:** Client applications should implement token refresh logic

### Activation Response
- **Old:** `{ token, existing }`
- **New:** `{ token, refresh_token, expires_in, existing }`

**Impact:** Update client code to handle new fields

---

## ğŸ”„ Migration

### Automatic
- Devices table auto-created on server start
- Existing tokens continue to work until expiration
- No manual database migration needed

### Manual (Optional)
If you want to clean up test data:
```sql
DELETE FROM devices WHERE customer_id IN (SELECT id FROM customers WHERE email LIKE '%test%');
```

---

## ğŸ“š Documentation

New documentation files:
- `jwt-implementation-review.md` - Implementation analysis
- `jwt-testing-guide.md` - Testing procedures
- `deployment-workflow.md` - Deployment guide
- `CHANGELOG.md` - Version history
- `v1.22-release-notes.md` - This file

---

## ğŸ› Known Issues

None at this time.

---

## ğŸ”® Next Steps

1. **Test on Ubuntu server** (Task #014)
2. **Create admin dashboard** for device management (Task #015)
3. **Implement device revocation** API
4. **Add usage analytics** per device
5. **Client-side integration** with AIPrivateSearch app

---

## ğŸ“ Support

If you encounter issues:
1. Check PM2 logs: `pm2 logs`
2. Verify database: `SHOW TABLES LIKE 'devices';`
3. Test endpoints with curl commands from testing guide
4. Review error messages for specific guidance

---

## âœ… Completed Tasks

- [x] Task #011: Tier checking and device limit enforcement
- [x] Task #012: Comprehensive app review
- [x] Task #013: JWT token plan review and implementation
- [x] Enhanced JWT payload with all fields
- [x] Device tracking database and logic
- [x] Check-limits API endpoint
- [x] Refresh token support
- [x] Helper functions for tier management
- [x] Comprehensive documentation

---

**Ready to deploy!** ğŸš€

Follow the deployment steps above to test on your Ubuntu server.
